external_data:
  pan_nz_draft:
    layer: PAN-NZ_Draft
    description: |-
      PAN-NZ Draft H3 12 (2025)
    license: https://creativecommons.org/licenses/by/4.0/
    attribution: # TODO
    external_data_type: wfs
    host: https://lris.scinfo.org.nz/services;key={key}/wfs
    key: LRIS_KEY
    layer: layer-122065
    geom_type: multipolygon
    derived_columns:
      - column: source_data
        datatype: text
        set_query: "'PAN-NZ'::TEXT"
      - column: source_date # Use date ranges if available, if both are null, then open lower limit but upper limit is data production date
        datatype: daterange
        set_query: |-
          (CASE
            WHEN source_start_date IS NOT NULL AND source_end_date IS NOT NULL
              THEN daterange(source_start_date::DATE, source_end_date::DATE, '[]')
            WHEN source_start_date IS NULL AND source_end_date IS NULL
              THEN daterange(NULL, '2025-04-15'::DATE, '(]')
            WHEN source_start_date IS NOT NULL
              THEN daterange(source_start_date::DATE, GREATEST(source_start_date::DATE, '2025-04-15'::DATE), '[]')
            WHEN source_end_date IS NOT NULL
              THEN daterange(LEAST(source_end_date::DATE, '2025-04-15'::DATE), source_end_date::DATE, '[]')
          END)
      - column: source_scale
        datatype: int4range
        set_query: "'[10,100]'::int4range"
    indices:
      - columns: [iucn_category]
        type: btree
        name: idx_btree_iucn_category
      - columns: [designation]
        type: btree
        name: idx_btree_designation
      - columns: [legislation_act]
        type: btree
        name: idx_btree_legislation_act
      - columns: [legislation_act, legislation_section]
        type: btree
        name: idx_btree_legislation_act_legislation_section
      - columns: [source_id]
        type: btree
        name: idx_btree_source_id
      - columns: [source_date]
        type: btree
        name: idx_btree_source_date
      - columns: [source_date, source_id]
        type: btree
        name: idx_btree_source_date_source_id